class e extends Error{constructor(e){super(e),this.name="SessionTerminatedError",this.stack=new Error(e).stack}}class t extends Error{constructor(e){super(e),this.name="TimedOutError",this.stack=new Error(e).stack}}async function o(o,n,a){var r,s,i;const d=(null==a?void 0:a.timeout)||5e3,l=null==a?void 0:a.shotCb,u=null==a?void 0:a.onDisconnect,c=null==a?void 0:a.onCloseWarning,m=null==a?void 0:a.onCursor,w=null==a?void 0:a.webhookUserdata,h=null==a?void 0:a.onConnectionStateChange,v=null==a?void 0:a.cn,b=v?"string"==typeof v?v:"jquery-jquery-iblnwrmmqd.cn-hangzhou.fcapp.run":"jquery.tutturu.workers.dev";let p,g,y,f,E=!1!==(null==a?void 0:a.delegateKeyboard),k=!1;const T=()=>{k=!0,/^https:\/\/[a-z0-9]{25}\.hyperbeam\.com\//.test(n)&&(n="https://"+b+n.substring(n.indexOf("/")+1))};let L,P,R;function C(){y({type:"blur"})}if("IFRAME"===o.nodeName){if(null==a?void 0:a.frameCb)throw new TypeError("frameCb is not supported with IFrame for performance reasons, please pass in a div");if(null==a?void 0:a.audioTrackCb)throw new TypeError("audioTrackCb cannot be used with IFrame, please pass in a div");o.allow="autoplay; clipboard-read; clipboard-write",await new Promise(((a,r)=>{const s=()=>{L=setTimeout(i,d),o.src=n},i=()=>{k?r(new t("Timed out")):(T(),s())};v&&T(),s(),o.addEventListener("load",(()=>{clearTimeout(L),a()}),{once:!0}),fetch(n).then((t=>{400===t.status&&r(new e("Provided Hyperbeam embed_url's session has terminated"))})).catch((()=>{k||(clearTimeout(L),T(),s())}))})),p=o.contentWindow,y=e=>{p.postMessage(e,"*")},window.addEventListener("message",z),E&&(window.addEventListener("keydown",F,{passive:!0}),window.addEventListener("keyup",F,{passive:!0})),window.addEventListener("pagehide",C),window.addEventListener("blur",C)}else{g=o.shadowRoot,g?g.innerHTML="":g=o.attachShadow({mode:"open"});const r=await new Promise(((e,o)=>{const a=t=>(clearTimeout(L),e(t),t),r=()=>{k||(clearTimeout(L),T(),s())},s=()=>{L=setTimeout(i,d);const e=fetch(n);e.then(a),e.catch(r)},i=()=>{k?o(new t("Timed out")):(T(),s())};v&&T(),s()}));if(400===r.status)throw new e("Provided Hyperbeam embed_url's session has terminated");const s=URL.createObjectURL(await r.blob()),i=(await import(/*webpackIgnore:true*//*@vite-ignore*/s)).default(g,r.url,D,a);y=i.handleMessage,f=i.destroy}w&&y({type:"webhook_auth",data:{webhookUserdata:w}});const A=await new Promise(((e,o)=>{R=e,P=setTimeout((()=>{o(new t("Timed out"))}),d)}));let{width:M,height:_}=A;const{user_id:Z,max_area:x}=A,S={},q=new Map,I=new Map;function U(){for(var e=0;;e++)if(!(e in S)&&!q.has(e))return e}async function z(e){e.source===p&&D(e.data)}async function D(e){var t;if("i"in e&&!("m"in e)){const{i:t}=e,o=S[t];if(o){clearTimeout(o[2]),delete S[t];const{e:n}=e;null!=n?o[1](new Error(n)):o[0](e.r)}else{const o=q.get(t);if(o){const{r:t}=e;Array.isArray(t)?o[1](...t):o[1](t)}}}else if("type"in e)switch(e.type){case"connection":clearTimeout(P),R(e.data);break;case"ext_reconn":{const e=new Set;for(const[t,[o,n,a]]of q)o&&!e.has(n)&&(q.delete(t),I.delete(n),e.add(n),o(n,...a));break}case"blur":null===(t=document.activeElement)||void 0===t||t.blur();break;case"screenshot":{const{mime:t,buf:o,tabId:n}=e.data;l&&l({tabId:n,img:new Blob([o],{type:t})});break}case"disconnect":u&&u(e.data);break;case"close_warning":c&&c(e.data);break;case"connection_state":h&&h(e.data);break;case"peer_mouse":m&&m(e.data);break;case"resize":M=e.data.width,_=e.data.height}}function F(e){const{activeElement:t}=document;t&&("INPUT"===t.nodeName||"TEXTAREA"===t.nodeName||t.isContentEditable)||y({type:e.type,key:e.key,ctrlKey:e.ctrlKey,metaKey:e.metaKey})}const H=(e,t)=>new Promise(((o,n)=>{const a=U(),r=setTimeout((()=>{const e=S[a];delete S[a],e[1](new Error("Timed out"))}),d);S[a]=[o,n,r],y({m:e,a:t,i:a,t:G})})),K=e=>(...t)=>H(e,t),j=(e,t=!0)=>{const o=`${e}.addListener`,n=`${e}.removeListener`;return{addListener:async function e(n,...a){if(I.has(n))throw new Error("Can't bind same callback twice");return new Promise(((r,s)=>{const i=U(),l=setTimeout((()=>{const e=S[i];delete S[i],q.delete(i),I.delete(n),e[1](new Error("Timed out"))}),d);S[i]=[r,s,l],q.set(i,[t?e:void 0,n,a]),I.set(n,i),y({m:o,a:a,i:i})}))},async removeListener(e){const t=I.get(e);null!=t&&(await H(n,[t]),q.delete(t),I.delete(e))}}},N=K("resize"),B=K("setPermissions"),O=K("addRoles"),$=K("removeRoles"),W=K("enablePrivacyMode"),X=K("disablePrivacyMode");let G=null==a?void 0:a.adminToken,J=null!==(r=null==a?void 0:a.volume)&&void 0!==r?r:1,Q=null!==(s=null==a?void 0:a.videoPaused)&&void 0!==s&&s,V=null!==(i=null==a?void 0:a.playoutDelay)&&void 0!==i&&i;const Y={userId:Z,get width(){return M},get height(){return _},maxArea:x,get adminToken(){return G},set adminToken(e){G=e,y({type:"admin_token",data:e})},tabs:{create:K("tabs.create"),detectLanguage:K("tabs.detectLanguage"),discard:K("tabs.discard"),duplicate:K("tabs.duplicate"),get:K("tabs.get"),getZoom:K("tabs.getZoom"),getZoomSettings:K("tabs.getZoomSettings"),goBack:K("tabs.goBack"),goForward:K("tabs.goForward"),group:K("tabs.group"),highlight:K("tabs.highlight"),move:K("tabs.move"),query:K("tabs.query"),reload:K("tabs.reload"),remove:K("tabs.remove"),setZoom:K("tabs.setZoom"),setZoomSettings:K("tabs.setZoomSettings"),ungroup:K("tabs.ungroup"),update:K("tabs.update"),onActivated:j("tabs.onActivated"),onCreated:j("tabs.onCreated"),onHighlighted:j("tabs.onHighlighted"),onMoved:j("tabs.onMoved"),onRemoved:j("tabs.onRemoved"),onReplaced:j("tabs.onReplaced"),onUpdated:j("tabs.onUpdated"),onZoomChange:j("tabs.onZoomChange")},reconnect(){y({type:"reconnect"})},resize(e,t){if(e<=0)throw new RangeError("width must greater than 0");if(t<=0)throw new RangeError("height must greater than 0");if(e*t>x)throw new RangeError(`width * height must be less than or equal to hb.maxArea: ${x}`);return N(~~e,~~t)},setPermissions(e,t){if(!G)throw new Error("Admin token not set");return B(e,t)},addRoles(e,t,o){if(!G)throw new Error("Admin token not set");return O(e,t,o)},removeRoles(e,t,o){if(!G)throw new Error("Admin token not set");return $(e,t,o)},enablePrivacyMode:e=>(e||(e=Z),W(e)),disablePrivacyMode:X,get videoPaused(){return Q},set videoPaused(e){Q=e,y({type:"video_paused",data:e})},get playoutDelay(){return V},set playoutDelay(e){V=e,y({type:"playout_delay",data:e})},get volume(){return J},set volume(e){J=e,y({type:"volume",data:e})},sendEvent(e){y(e)},screenshot:K("screenshot"),ping(){y({type:"ping"})},destroy(){g?f():(window.removeEventListener("message",z),E&&(window.removeEventListener("keydown",F),window.removeEventListener("keyup",F)),window.removeEventListener("pagehide",C),window.removeEventListener("blur",C)),q.clear(),I.clear()}};return void 0!==G&&(Y.adminToken=G),1!==J&&(Y.volume=J),Q&&(Y.videoPaused=Q),V&&(Y.playoutDelay=V),Y}export{e as SessionTerminatedError,t as TimedOutError,o as default};